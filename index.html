<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –∏ –º–∞—Å—à—Ç–∞–±–∞ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- –ú–µ—Ç–∞-—Ç–µ–≥–∏ SEO –¥–ª—è –æ–±–æ–∏—Ö —è–∑—ã–∫–æ–≤ -->
    <meta name="description" content="TODO List is a handy notebook for managing tasks. Share your list offline and with others, access it anytime, and improve your productivity.">
    <meta name="keywords" content="TODO, task list, notebook, productivity, tasks, management">
    <meta name="author" content="localhost-four.github.io">

    <!-- Open Graph –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π (Facebook, LinkedIn, WhatsApp) -->
    <meta property="og:title" content="TODO List - Task Management App">
    <meta property="og:description" content="Manage your tasks effectively. Share your TODO list offline and with others. Access your tasks anytime, anywhere.">
    <meta property="og:image" content="1img.gif">
    <meta property="og:url" content="https://localhost-four.github.io/TODO/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="TODO List">
    
    <!-- –ú–µ—Ç–∞-—Ç–µ–≥–∏ –¥–ª—è Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="TODO List - Task Management App">
    <meta name="twitter:description" content="Manage your tasks effectively. Share your TODO list offline and with others. Access your tasks anytime, anywhere.">
    <meta name="twitter:image" content="1img.gif">
    <meta name="twitter:url" content="https://localhost-four.github.io/TODO/">

    <!-- –ò–∫–æ–Ω–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ -->
    <link rel="icon" href="1img.gif">
    <link rel="apple-touch-icon" href="1img.gif">
    <link rel="icon" sizes="192x192" href="1img.gif">
    <link rel="icon" sizes="512x512" href="1img.gif">

    <!-- –ú–∞–Ω–∏—Ñ–µ—Å—Ç –¥–ª—è PWA -->
    <link rel="manifest" href="manifest.json">
    <link href="%PUBLIC_URL%/manifest.json" rel="manifest" />


    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <title>TODO List ‚Äî Task Management App</title>

    <!-- Firebase SDK -->
    <!-- <meta http-equiv="Content-Security-Policy" content="script-src 'self' http://127.0.0.1:3000;"> -->
    <!-- <meta http-equiv="Content-Security-Policy" content="script-src 'self' http://127.0.0.1:3000; 'nonce-xyz123';"> -->
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase SDK –¥–ª—è –º–æ–¥—É–ª–µ–π -->
    <script type="module">
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Firebase —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ES Modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js';
    
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDMek24rrioHn3kPaOGDCNIgq1CU7ROVsE",
            authDomain: "todo-4e809.firebaseapp.com",
            projectId: "todo-4e809",
            storageBucket: "todo-4e809.firebasestorage.app",
            messagingSenderId: "166519588590",
            appId: "1:166519588590:web:cb3f6b4e6cba1749a515ff",
            measurementId: "G-45P7VYXPCZ"
        };
    
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
    
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Å—ã–ª–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const currentUrl = window.location.href;
    
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞ –º–µ–∂–¥—É –¥–≤—É–º—è —Å—Ç—Ä–æ–∫–∞–º–∏
        function levenshtein(a, b) {
            const tmp = [];
            let i, j, alen = a.length, blen = b.length, cost;
            if (alen === 0) { return blen; }
            if (blen === 0) { return alen; }
            for (i = 0; i <= alen; i++) { tmp[i] = [i]; }
            for (j = 0; j <= blen; j++) { tmp[0][j] = j; }
            for (i = 1; i <= alen; i++) {
                for (j = 1; j <= blen; j++) {
                    cost = (a[i - 1] === b[j - 1]) ? 0 : 1;
                    tmp[i][j] = Math.min(tmp[i - 1][j] + 1, tmp[i][j - 1] + 1, tmp[i - 1][j - 1] + cost);
                }
            }
            return tmp[alen][blen];
        }
    
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ö–æ–∂–µ—Å—Ç–∏ –º–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º URL –∏ —Å—Å—ã–ª–∫–∞–º–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        async function isUrlSimilar(url) {
            const threshold = 0.8;  // –ü–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏ (80%)
            const querySnapshot = await getDocs(collection(db, "urls"));
            let similarFound = false;
            
            querySnapshot.forEach((doc) => {
                const storedUrl = doc.data().url;
                const distance = levenshtein(url, storedUrl);
                const maxLength = Math.max(url.length, storedUrl.length);
                const similarity = 1 - (distance / maxLength); // –°—á–∏—Ç–∞–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å –∫–∞–∫ 1 - –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞
    
                if (similarity > threshold) {
                    similarFound = true; // –ï—Å–ª–∏ —Å—Ö–æ–∂–µ—Å—Ç—å –±–æ–ª—å—à–µ –ø–æ—Ä–æ–≥–∞, —Å—á–∏—Ç–∞–µ–º —Å—Å—ã–ª–∫—É –ø–æ—Ö–æ–∂–µ–π
                }
            });
    
            return similarFound;
        }
    
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ URL
        function isValidUrl(url) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ URL –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å localhost –∏–ª–∏ 127.0.0.1
            if (url.includes("127.0.0.1") || url.includes("localhost")) {
                return false;
            }
    
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ URL –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞
            if (!url.startsWith("https://localhost-four.github.io/TODO/")) {
                return false;
            }
    
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ URL —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –¥–æ–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
            if (url === "https://localhost-four.github.io/TODO/" || url === `https://localhost-four.github.io/TODO/?state=%7B"boards"%3A%5B%7B"id"%3A"board1"%2C"name"%3A"Board%201"%2C"emoji"%3A"üìù"%2C"backgroundColor"%3A"%23ffffff"%2C"textColor"%3A"%23000000"%2C"style"%3A"flex"%2C"tasks"%3A%5B%5D%7D%5D%2C"activeBoardId"%3Anull%2C"theme"%3A"light"%7D`) {
                return false;
            }
            console.log('Updata');
            return true;
        }
    
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—É—â–µ–π —Å—Å—ã–ª–∫–∏ –≤ Firestore
        async function sendUrlToFirestore() {
            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ URL –≤–∞–ª–∏–¥–µ–Ω
                if (!isValidUrl(currentUrl)) {
                    console.log("URL –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–æ–ø—É—Å—Ç–∏–º—ã–º. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å.");
                    return;
                }
    
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Å—Å—ã–ª–∫–∞ –∏–ª–∏ —Å—Ö–æ–∂–∞—è
                const urlIsSimilar = await isUrlSimilar(currentUrl);
                if (!urlIsSimilar) {
                    // –ï—Å–ª–∏ —Å—Ö–æ–∂–∏—Ö URL –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π URL –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                    await addDoc(collection(db, "urls"), {
                        url: currentUrl,
                        timestamp: new Date().toISOString()
                    });
                    console.log("URL –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.");
                } else {
                    console.log("–≠—Ç–æ—Ç URL –∏–ª–∏ –µ–≥–æ —Å–ª–∏—à–∫–æ–º —Å—Ö–æ–∂–∞—è –≤–µ—Ä—Å–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.");
                }
    
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–æ–ª—å–∫–æ —Å—Å—ã–ª–æ–∫ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                const querySnapshot = await getDocs(collection(db, "urls"));
                const urlCount = querySnapshot.size; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    
                // –ï—Å–ª–∏ —Å—Å—ã–ª–æ–∫ –±–æ–ª—å—à–µ 30, –æ—á–∏—â–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                if (urlCount > 30) {
                    console.log("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Å—ã–ª–æ–∫ –±–æ–ª—å—à–µ 30. –û—á–∏—â–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.");
                    await clearDatabase();  // –û—á–∏—â–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                }
    
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ URL:", error);
            }
        }
    
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        async function clearDatabase() {
            try {
                const querySnapshot = await getDocs(collection(db, "urls")); // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ "urls"
                
                // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —É–¥–∞–ª—è–µ–º –µ–≥–æ
                querySnapshot.forEach(async (docSnapshot) => {
                    await deleteDoc(doc(db, "urls", docSnapshot.id)); // –£–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ ID
                });
    
                console.log("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞.");
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:", error);
            }
        }
    
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Å—ã–ª–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        sendUrlToFirestore();
    </script>
    


    <link rel="stylesheet" href="styles.css">
    <script src="script.js" defer nonce="xyz123"></script>
    <script src="manifest.js" defer nonce="xyz123"></script>
    <script src="service-worker.js" defer nonce="xyz123"></script>
    <script src="notifications.js" defer nonce="xyz123"></script>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="app-header">
                <a href="#top" onclick="copy()" nonce="xyz123">TODO</a>
                <a href="home/">LOOK</a>
                <div class="tabs-container">
                    <button class="tab" nonce="xyz123" onclick="openNewBoardTab()">DESK</button>
                    <button class="tab" nonce="xyz123" onclick="openAddTaskModal()">TASK</button>
                </div>
            </div>
        </header>
        <div class="tabs-container">
            <div id="tabs"></div>
        </div>

        <div class="task-container" id="task-container">
            <!-- –î–æ—Å–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
        </div>
        
        <!-- Modal for Adding Tasks -->
        <div class="modal" id="addTaskModal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()" nonce="xyz123">&times;</span>
                <h2>Add Task</h2>
                <input type="text" id="taskTitle" placeholder="Task Title">
                <input type="date" id="taskDeadline">
                <script nonce="xyz123">
                    document.getElementById('taskDeadline').value = new Date().toISOString().split('T')[0];
                </script>
                <textarea id="taskDescription" placeholder="Task Description"></textarea>
                <input type="url" id="taskImageUrl" placeholder="Image URL (Only for Image)">
                <input type="url" id="taskLink" placeholder="Resource Link (url)">
                <select id="taskPriority">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
                <button onclick="addTask()" nonce="xyz123">Add Task</button>
                <div id="filePreview" class="file-preview"></div>
            </div>
        </div>


        <!-- Modal for Board Settings -->
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <span class="close" onclick="closeSettings()" nonce="xyz123">&times;</span>
                <h2>Board Settings</h2>
                <label>Emoji:</label>
                <input type="text" id="emojiInput">
                <label>Background Color:</label>
                <input type="color" id="backgroundColorInput">
                <label>Text Color:</label>
                <input type="color" id="textColorInput">
                <label>Style:</label>
                <select id="styleInput">
                    <option value="block">Block</option>
                    <option value="grid">Grid</option>
                    <option value="flex">Flex</option>
                </select>
                <button onclick="applyBoardSettings()" nonce="xyz123">Apply</button>
            </div>
        </div>

        <!-- Modal for adding comment -->
        <div id="commentModal" class="modal">
            <div class="modal-content">
                <h2>Add Comment</h2>
                <textarea id="commentText" placeholder="Enter your comment..."></textarea>
                
                <div>
                    <label for="urlInput">Image URL:</label>
                    <input type="url" id="urlInput" placeholder="Enter image URL">
                </div>
                
                <button id="saveCommentBtn">Save Comment</button>
                <button onclick="closeCommentModal()" nonce="xyz123">Cancel</button>
            </div>
        </div>
    </div>

</body>
</html>